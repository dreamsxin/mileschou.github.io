---
published: false
title: OAuth 2.0 之 Authorization Code Grant
layout: post
tags:
- ironman
- ironman-11th
- authentication
---

Authorization Code Grant 是相較其他三種授權類型而言，最複雜的一種。但就讓使用者授護的目的而言，這個授權類型相較設計的比較合理也安全。

> *Client credentials grant* 設計上並沒有經過使用者授權，因此它雖然安全，但就目的而言不完全合理。

## 註冊 Client

之前討論[身分驗證可以怎麼做][Day 13]的時候曾提過，在做身分驗證前要先註冊實體。同樣地，client 在開始要求授權之前，也得先跟授權伺服器註冊 client 的相關資訊。

| 註冊資訊 | 說明 |
| --- | --- |
| client identifier | client 的唯一識別碼 |
| client authentication | client 認證的方法，如[密碼][Day 15]或是 [JWT][Day 22] 等 |
| client password | client 的密碼認證方法，若授權伺服器有發密碼的話，則必須提供 [HTTP basic authentication scheme][Day 14] |
| redirection endpoint | 規範提到 public client 才需要，但實務上還是都會在註冊的時候提供資訊，以確保安全 |

## 授權流程

時序圖如下：

![](http://www.plantuml.com/plantuml/png/TP1H2i8m44J_FSLS81SeHLfw0A5wWP0C6Am9RZOAdjvAwKTj_DrzE_FOBgiLBVVfC3Ad8ewdLwIWDHYcmAWDHleWT0fDw8jUauItrP3YcVAa_1oQOmrgi59Oi2ypfmTdbNdVNOtO334apttt8brbbnNCFyED4cpq43uAiw9tZZdZacwCQqnhwfPRk6FqytC_)

```
@startuml
ResourceOwner <- Client: Redirect to AuthorizationServer
ResourceOwner -> AuthorizationServer: Resource Owner Authenticates
ResourceOwner <- AuthorizationServer: Authorization Code
ResourceOwner -> Client: Authorization Code
Client --> AuthorizationServer: Authenticates and request Access Token
Client <-- AuthorizationServer: Access Token
@enduml
```

首先會由 client 透過 User Agent 發出[授權請求（authorization request）](https://tools.ietf.org/html/rfc6749#section-4.1.1)到授權伺服器的[授權端口（authorization endpoint）](https://tools.ietf.org/html/rfc6749#section-3.1)，這個請求會帶有下列資訊：

| 欄位名稱 | 必要參數 | 說明 |
| --- | --- | --- |
| response_type | REQUIRED | 指的是回應類型為何，以此授權類型的話是 `code` |
| client_id | REQUIRED | client 預先註冊好的唯一識別碼 |
| redirect_uri | OPTIONAL | client 預先註冊好的轉導頁面 |
| scope | OPTIONAL | 授權範圍 |
| state | RECOMMENDED | 亂數，可用來確保授權請求與授權回應為同一使用者 |

而這些參數使用 `application/x-www-form-urlencoded` 編碼後，把它作為 HTTP query 放到授權端口的後面，並產生 URI。接著讓 Client 使用 302 redirect 到此 URI。


## 參考資料

* [RFC 6749][]

[RFC 6749]: https://tools.ietf.org/html/rfc6749

[Day 13]: {% post_url ironman/11th/authentication/2019-09-29-day13 %}
[Day 14]: {% post_url ironman/11th/authentication/2019-09-30-day14 %}
[Day 15]: {% post_url ironman/11th/authentication/2019-10-01-day15 %}
[Day 22]: {% post_url ironman/11th/authentication/2019-10-08-day22 %}
